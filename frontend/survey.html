<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜í™” ì •ë³´ ì…ë ¥ - í‰ì  ì˜ˆì¸¡</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            background: #f5f6fa; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
            box-sizing: border-box;
        }
        .survey-container { 
            background: #fff; 
            border-radius: 12px; 
            padding: 40px 30px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.07); 
            max-width: 600px; 
            width: 100%;
        }
        h2 { 
            margin-bottom: 24px; 
            color: #27408b; 
            text-align: center;
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            margin-top: 16px; 
            font-weight: bold;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            margin-bottom: 10px; 
            box-sizing: border-box;
            font-size: 14px;
        }
        .checkbox-group { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .checkbox-group label { 
            margin: 0; 
            font-weight: normal; 
            display: flex; 
            align-items: center;
            font-size: 13px;
            cursor: pointer;
        }
        .checkbox-group input { 
            width: auto; 
            margin-right: 8px;
            margin-bottom: 0;
        }
        .checkbox-group label:hover {
            background: #e3f2fd;
            border-radius: 4px;
            padding: 2px;
        }
        button { 
            width: 100%; 
            background: #27408b; 
            color: #fff; 
            padding: 15px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            cursor: pointer; 
            margin-top: 10px;
            transition: background 0.3s;
        }
        button:hover { 
            background: #4169e1;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px; 
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .result h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .result .score {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .result .method {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }
        .status { 
            padding: 12px; 
            margin-bottom: 20px; 
            border-radius: 6px; 
            text-align: center; 
            font-size: 14px;
        }
        .status.warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 10px;
        }
        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #27408b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .genre-count {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="survey-container">
        <h2>ğŸ¬ ì˜í™” í‰ì  ì˜ˆì¸¡</h2>
        
        <div class="status warning" id="model-status">
            âš ï¸ ìƒíƒœ í™•ì¸ ì¤‘...
        </div>
        
        <form id="survey-form">
            <label>ì„±ì¸ì˜í™” ì—¬ë¶€</label>
            <select name="adult">
                <option value="">ì„ íƒì•ˆí•¨</option>
                <option value="0">ì•„ë‹ˆì˜¤</option>
                <option value="1">ì˜ˆ</option>
            </select>
            
            <label>ì¥ë¥´ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="genre_ids" value="28"> ì•¡ì…˜</label>
                <label><input type="checkbox" name="genre_ids" value="12"> ëª¨í—˜</label>
                <label><input type="checkbox" name="genre_ids" value="16"> ì• ë‹ˆë©”ì´ì…˜</label>
                <label><input type="checkbox" name="genre_ids" value="35"> ì½”ë¯¸ë””</label>
                <label><input type="checkbox" name="genre_ids" value="80"> ë²”ì£„</label>
                <label><input type="checkbox" name="genre_ids" value="99"> ë‹¤íë©˜í„°ë¦¬</label>
                <label><input type="checkbox" name="genre_ids" value="18"> ë“œë¼ë§ˆ</label>
                <label><input type="checkbox" name="genre_ids" value="10751"> ê°€ì¡±</label>
                <label><input type="checkbox" name="genre_ids" value="14"> íŒíƒ€ì§€</label>
                <label><input type="checkbox" name="genre_ids" value="36"> ì—­ì‚¬</label>
                <label><input type="checkbox" name="genre_ids" value="27"> ê³µí¬</label>
                <label><input type="checkbox" name="genre_ids" value="10402"> ìŒì•…</label>
                <label><input type="checkbox" name="genre_ids" value="9648"> ë¯¸ìŠ¤í„°ë¦¬</label>
                <label><input type="checkbox" name="genre_ids" value="10749"> ë¡œë§¨ìŠ¤</label>
                <label><input type="checkbox" name="genre_ids" value="878"> SF</label>
                <label><input type="checkbox" name="genre_ids" value="10770"> TV ì˜í™”</label>
                <label><input type="checkbox" name="genre_ids" value="53"> ìŠ¤ë¦´ëŸ¬</label>
                <label><input type="checkbox" name="genre_ids" value="10752"> ì „ìŸ</label>
                <label><input type="checkbox" name="genre_ids" value="37"> ì„œë¶€</label>
            </div>
            <div class="genre-count" id="genre-count">ì„ íƒëœ ì¥ë¥´: 0ê°œ</div>
            
            <label>ì›ì–´(ì–¸ì–´)</label>
            <select name="original_language">
                <option value="">ì„ íƒì•ˆí•¨</option>
                <option value="ko">í•œêµ­ì–´</option>
                <option value="en">ì˜ì–´</option>
                <option value="ja">ì¼ë³¸ì–´</option>
                <option value="zh">ì¤‘êµ­ì–´</option>
                <option value="fr">í”„ë‘ìŠ¤ì–´</option>
                <option value="de">ë…ì¼ì–´</option>
                <option value="es">ìŠ¤í˜ì¸ì–´</option>
            </select>
            
            <label>ì¤„ê±°ë¦¬</label>
            <textarea name="overview" rows="4" placeholder="ì˜í™” ì¤„ê±°ë¦¬ë¥¼ ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. ë” ìì„¸í• ìˆ˜ë¡ ì˜ˆì¸¡ ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤!"></textarea>
            
            <label>í”Œë«í¼ ì„ íƒ</label>
            <select name="video">
                <option value="">ì„ íƒì•ˆí•¨</option>
                <option value="0">ê·¹ì¥ ê°œë´‰</option>
                <option value="1">ì§ì ‘ ë°°ê¸‰ (ë„·í”Œë¦­ìŠ¤, OTT ë“±)</option>
            </select>
            
            <button type="submit" id="predict-btn">ğŸ¯ í‰ì  ì˜ˆì¸¡í•˜ê¸°</button>
            <div class="loading" id="loading">ì˜ˆì¸¡ ì¤‘...</div>
        </form>
        
        <div id="result" class="result">
            <h3>ğŸ¬ ì˜ˆì¸¡ ê²°ê³¼</h3>
            <div class="score" id="pred-score"></div>
            <div id="pred-message"></div>
            <div class="method" id="pred-method"></div>
        </div>
    </div>
    
    <script>
        // ì„œë²„ ìƒíƒœ í™•ì¸
        fetch('/predict/health')
            .then(r => r.json())
            .then(data => {
                const statusEl = document.getElementById('model-status');
                if (data.model_loaded) {
                    statusEl.className = 'status ok';
                    statusEl.innerHTML = 'ğŸ¤– <strong>ML ëª¨ë¸ í™œì„±</strong> - ì‹¤ì œ ë¨¸ì‹ ëŸ¬ë‹ ì˜ˆì¸¡';
                } else {
                    statusEl.className = 'status warning';
                    statusEl.innerHTML = 'âš ï¸ <strong>í´ë°± ëª¨ë“œ</strong> - ê·œì¹™ ê¸°ë°˜ ì˜ˆì¸¡ (ì •í™•ë„ ì•½ 70-80%)';
                }
            })
            .catch(e => {
                document.getElementById('model-status').innerHTML = 'âŒ ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
            });

        // ì¥ë¥´ ì„ íƒ ì¹´ìš´í„°
        document.addEventListener('change', function(e) {
            if (e.target.name === 'genre_ids') {
                const checkedGenres = document.querySelectorAll('input[name="genre_ids"]:checked');
                document.getElementById('genre-count').textContent = `ì„ íƒëœ ì¥ë¥´: ${checkedGenres.length}ê°œ`;
            }
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const predictBtn = document.getElementById('predict-btn');
            const loading = document.getElementById('loading');
            const resultDiv = document.getElementById('result');
            
            // UI ìƒíƒœ ë³€ê²½
            predictBtn.disabled = true;
            predictBtn.textContent = 'ì˜ˆì¸¡ ì¤‘...';
            loading.style.display = 'block';
            resultDiv.style.display = 'none';
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const adult = form.adult.value === "" ? null : Number(form.adult.value);
            const original_language = form.original_language.value === "" ? null : form.original_language.value;
            const overview = form.overview.value.trim() === "" ? null : form.overview.value.trim();
            const video = form.video.value === "" ? null : Number(form.video.value);
            
            const genreNodes = form.querySelectorAll('input[name="genre_ids"]:checked');
            const genre_ids = Array.from(genreNodes).map(x => Number(x.value));

            const payload = {
                adult, 
                genre_ids: genre_ids.length ? genre_ids : null, 
                original_language, 
                overview, 
                video
            };

            try {
                const res = await fetch('/predict/json', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status}`);
                }
                
                const data = await res.json();
                
                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('pred-score').textContent = `${data.pred}ì `;
                
                // ì ìˆ˜ì— ë”°ë¥¸ ë©”ì‹œì§€
                let message = '';
                if (data.pred >= 8.5) {
                    message = 'ğŸ† ìµœê³  ìˆ˜ì‘! ê¼­ ë´ì•¼ í•  ì˜í™”';
                } else if (data.pred >= 7.5) {
                    message = 'â­ í›Œë¥­í•œ ì‘í’ˆ! ì¶”ì²œí•©ë‹ˆë‹¤';
                } else if (data.pred >= 6.5) {
                    message = 'ğŸ‘ ê´œì°®ì€ ì˜í™”ì…ë‹ˆë‹¤';
                } else if (data.pred >= 5.5) {
                    message = 'ğŸ˜ í‰ë²”í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤';
                } else {
                    message = 'ğŸ˜ ì•„ì‰¬ìš´ ì‘í’ˆì¼ ìˆ˜ ìˆì–´ìš”';
                }
                
                document.getElementById('pred-message').textContent = message;
                document.getElementById('pred-method').textContent = data.message || '';
                
                // ê²°ê³¼ í‘œì‹œ
                resultDiv.style.display = 'block';
                
                // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
                resultDiv.scrollIntoView({ behavior: 'smooth' });
                
            } catch (err) {
                alert(`ì˜ˆì¸¡ ì‹¤íŒ¨: ${err.message}\n\nì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            } finally {
                // UI ìƒíƒœ ë³µì›
                predictBtn.disabled = false;
                predictBtn.textContent = 'ğŸ¯ í‰ì  ì˜ˆì¸¡í•˜ê¸°';
                loading.style.display = 'none';
            }
        });

        // ì—”í„°í‚¤ë¡œ í¼ ì œì¶œ ë°©ì§€ (textarea ì œì™¸)
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>